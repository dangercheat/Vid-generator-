<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Download Editor</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #000; color: #00ffcc; font-family: sans-serif; text-align: center; padding: 20px; }
        .card { border: 2px solid #00ffcc; border-radius: 15px; padding: 25px; background: #0a0a0a; max-width: 400px; margin: auto; }
        #count { font-size: 50px; font-weight: bold; margin: 10px 0; }
        button { width: 100%; padding: 15px; background: #00ffcc; color: #000; border: none; font-weight: bold; border-radius: 10px; cursor: pointer; }
        .download-btn { display: none; background: #ff0055; color: white; text-decoration: none; padding: 15px; border-radius: 10px; display: none; margin-top: 20px; font-weight: bold; }
        .status { font-size: 12px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>DOWNLOAD_FIX_V5</h2>
    
    <input type="file" id="v" accept="video/*" style="width:100%; margin-bottom:10px;">
    <input type="file" id="a" accept="video/*,audio/*" style="width:100%; margin-bottom:10px;">

    <div id="count">0</div>
    <div id="status" class="status">Waiting for files...</div>

    <button id="startBtn">START EDIT</button>

    <a id="downloadBtn" class="download-btn">DOWNLOAD MP4</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let wakeLock = null;

    async function stayAwake() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
        }
    }

    ffmpeg.setLogger(({ message }) => {
        const frameMatch = message.match(/frame=\s*(\d+)/);
        if (frameMatch) document.getElementById('count').innerText = frameMatch[1];
    });

    document.getElementById('startBtn').onclick = async () => {
        const vFile = document.getElementById('v').files[0];
        const aFile = document.getElementById('a').files[0];
        if(!vFile || !aFile) return alert("Select files first!");

        await stayAwake();
        const btn = document.getElementById('startBtn');
        const dlBtn = document.getElementById('downloadBtn');
        const status = document.getElementById('status');

        btn.disabled = true;
        dlBtn.style.display = "none"; // Hide old button if re-running

        if (!ffmpeg.isLoaded()) {
            status.innerText = "Loading Engine...";
            await ffmpeg.load();
        }

        status.innerText = "Processing Video Data...";
        ffmpeg.FS('writeFile', 'vid.mp4', await fetchFile(vFile));
        ffmpeg.FS('writeFile', 'aud.mp4', await fetchFile(aFile));

        status.innerText = "Rendering (DO NOT CLOSE)...";

        try {
            // High-Speed Mobile Friendly Filter
            await ffmpeg.run(
                '-i', 'vid.mp4', '-i', 'aud.mp4',
                '-t', '12',
                '-filter_complex', "[0:v]scale=480:854,crop=480:854,eq=saturation=1.4[v]",
                '-map', '[v]', '-map', '1:a',
                '-c:v', 'libx264', '-preset', 'ultrafast', 'output.mp4'
            );

            // FIXING THE DOWNLOAD ERROR:
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            
            dlBtn.href = url;
            dlBtn.download = "Edited_Video.mp4";
            dlBtn.style.display = "block"; // Show button only when ready
            
            status.innerText = "SUCCESS! Click Download.";
            if(wakeLock) wakeLock.release();
            btn.disabled = false;
        } catch (e) {
            status.innerText = "Memory Error! File too large.";
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
