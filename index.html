<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Video Editor</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #000; color: #00ffcc; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }
        .main-box { border: 2px solid #00ffcc; border-radius: 20px; padding: 25px; background: #0a0a0a; max-width: 450px; margin: auto; }
        .count-num { font-size: 55px; font-weight: 800; color: #fff; margin: 15px 0; }
        input[type="file"] { width: 100%; margin: 10px 0; padding: 12px; background: #111; color: #fff; border: 1px solid #333; border-radius: 8px; }
        button { width: 100%; padding: 20px; background: #00ffcc; color: #000; border: none; font-weight: bold; border-radius: 12px; cursor: pointer; font-size: 16px; }
        #status { font-size: 12px; color: #888; margin-top: 15px; }
        .progress-container { width: 100%; background: #222; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: #00ffcc; transition: 0.3s; }
    </style>
</head>
<body>

<div class="main-box">
    <h2 style="margin-top:0;">UNIVERSAL_EDITOR</h2>
    
    <label style="font-size: 10px; display:block; text-align:left;">UPLOAD VIDEO:</label>
    <input type="file" id="videoFile" accept="video/*">
    
    <label style="font-size: 10px; display:block; text-align:left;">UPLOAD AUDIO/MUSIC:</label>
    <input type="file" id="audioFile" accept="video/*,audio/*">

    <div class="count-num" id="frameDisplay">0</div>
    <div style="font-size: 10px; margin-bottom: 10px;">PROGRESS: FRAMES RENDERED</div>

    <div class="progress-container"><div id="progress-fill"></div></div>

    <button id="startBtn">START GENERATING</button>
    <p id="status">Waiting for files...</p>
    
    <a id="downloadLink" style="display:none; margin-top:20px; color:#ff0055; font-weight:bold; text-decoration:none; display:block;" href="#"></a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let wakeLock = null;

    // Prevents TECNO sleep
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }

    ffmpeg.setLogger(({ message }) => {
        const frameMatch = message.match(/frame=\s*(\d+)/);
        if (frameMatch) document.getElementById('frameDisplay').innerText = frameMatch[1];
    });

    document.getElementById('startBtn').onclick = async () => {
        const v = document.getElementById('videoFile').files[0];
        const a = document.getElementById('audioFile').files[0];
        if(!v || !a) return alert("Please select both a video and an audio file!");

        await requestWakeLock();
        const btn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        btn.disabled = true;

        if (!ffmpeg.isLoaded()) {
            status.innerText = "Loading Engine (Wasm)...";
            await ffmpeg.load();
        }

        status.innerText = "Reading Files...";
        ffmpeg.FS('writeFile', 'input_v.mp4', await fetchFile(v));
        ffmpeg.FS('writeFile', 'input_a.mp4', await fetchFile(a));

        status.innerText = "Rendering Pro Edit...";

        // Filter: Scale to Vertical, Sharpness, Contrast, and Shake
        const complexFilter = "[0:v]scale=-1:1080,crop=608:1080,unsharp=5:5:1.0,eq=contrast=1.2:saturation=1.4,zoompan=z='min(zoom+0.001,1.1)':d=1:x='iw/2-(iw/zoom/2)+rand(-2,2)':y='ih/2-(ih/zoom/2)+rand(-2,2)'[v]";

        try {
            await ffmpeg.run(
                '-i', 'input_v.mp4',
                '-i', 'input_a.mp4',
                '-t', '12', // 12 second length
                '-filter_complex', complexFilter,
                '-map', '[v]', '-map', '1:a',
                '-c:v', 'libx264', '-preset', 'ultrafast', 'output.mp4'
            );

            const data = ffmpeg.FS('readFile', 'output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            const dl = document.getElementById('downloadLink');
            dl.href = url;
            dl.download = "Edited_Video.mp4";
            dl.innerText = "⬇️ DOWNLOAD FINISHED VIDEO ⬇️";
            dl.style.display = "block";
            
            status.innerText = "Render Complete!";
            if(wakeLock) wakeLock.release();
            btn.disabled = false;
        } catch (e) {
            status.innerText = "Error: File too large for RAM.";
            btn.disabled = false;
        }
    };

    ffmpeg.setProgress(({ ratio }) => {
        document.getElementById('progress-fill').style.width = (ratio * 100) + "%";
    });
</script>

</body>
</html>
