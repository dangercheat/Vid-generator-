<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #050505; color: #fff; font-family: 'Arial', sans-serif; text-align: center; padding: 20px; }
        .edit-box { border: 2px solid #ff0055; padding: 25px; border-radius: 20px; background: #000; box-shadow: 0 0 20px #ff0055; max-width: 400px; margin: auto; }
        #count { font-size: 50px; color: #ff0055; font-weight: 900; margin: 15px 0; }
        button { width: 100%; padding: 15px; background: #ff0055; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .status { color: #888; font-size: 11px; margin-top: 10px; }
        #dlLink { display: none; margin-top: 20px; color: #00ffcc; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="edit-box">
    <h2 style="letter-spacing: 2px;">ANIME_EDIT_V2</h2>
    <input type="file" id="v" accept="video/*" style="width:100%; margin-bottom:10px;">
    <input type="file" id="a" accept="video/*,audio/*" style="width:100%; margin-bottom:10px;">
    
    <div id="count">0</div>
    <div id="status" class="status">System Ready</div>
    
    <button id="start">RENDER FULL EDIT</button>
    <a id="dlLink" href="#">⬇️ DOWNLOAD EDITED MP4 ⬇️</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    ffmpeg.setLogger(({ message }) => {
        const frameMatch = message.match(/frame=\s*(\d+)/);
        if (frameMatch) document.getElementById('count').innerText = frameMatch[1];
    });

    document.getElementById('start').onclick = async () => {
        const btn = document.getElementById('start');
        const status = document.getElementById('status');
        btn.disabled = true;

        if (!ffmpeg.isLoaded()) {
            status.innerText = "Igniting Engine...";
            await ffmpeg.load();
        }

        status.innerText = "Loading Clips...";
        ffmpeg.FS('writeFile', 'v.mp4', await fetchFile(document.getElementById('v').files[0]));
        ffmpeg.FS('writeFile', 'a.mp4', await fetchFile(document.getElementById('a').files[0]));

        status.innerText = "Applying Hard FX...";

        /** * FX SETTINGS:
         * 1. scale/crop: Sets 9:16 Vertical.
         * 2. eq: Boosts saturation (vibrance) and contrast.
         * 3. zoompan: Adds a slow zoom-in transition.
         * 4. flicker: The 'geq' filter adds white flashes on specific frames.
         */
        const complexFX = "[0:v]scale=-1:1080,crop=608:1080,eq=saturation=1.7:contrast=1.3,zoompan=z='min(zoom+0.0015,1.25)':d=1:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)'[v1];" +
                          "[v1]geq=lum='if(gt(mod(n,10),7),255,p(X,Y))'[v]";

        await ffmpeg.run(
            '-ss', '00:00:10', '-t', '10', // Takes 10 seconds of video
            '-i', 'v.mp4', '-i', 'a.mp4',
            '-filter_complex', complexFX,
            '-map', '[v]', '-map', '1:a',
            '-c:v', 'libx264', '-preset', 'ultrafast', '-crf', '28', 'final.mp4'
        );

        const data = ffmpeg.FS('readFile', 'final.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
        const dl = document.getElementById('dlLink');
        dl.href = url; dl.download = "Full_Anime_Edit.mp4";
        dl.style.display = "block";
        
        status.innerText = "COMPLETE!";
        btn.disabled = false;
    };
</script>
</body>
</html>
