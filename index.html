<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background: #000; color: #00ffcc; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }
        .container { border: 2px solid #ff0055; border-radius: 20px; padding: 30px; background: #050505; box-shadow: 0 0 30px #ff005566; max-width: 400px; margin: auto; }
        .count-display { font-size: 60px; font-weight: 900; color: #fff; margin: 20px 0; text-shadow: 0 0 15px #ff0055; }
        input { width: 100%; margin: 10px 0; padding: 12px; background: #111; color: #fff; border: 1px solid #333; border-radius: 10px; }
        button { width: 100%; padding: 20px; background: #ff0055; color: #fff; border: none; font-weight: bold; border-radius: 12px; cursor: pointer; font-size: 18px; transition: 0.3s; }
        button:active { transform: scale(0.95); background: #cc0044; }
        #status { font-size: 13px; color: #666; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color:#ff0055; margin-bottom:5px;">TIKTOK_PRO</h1>
    <p style="font-size:10px; margin-bottom:25px;">SHAKE + FLASH + VIBRANCE</p>

    <input type="file" id="v" accept="video/mp4">
    <input type="file" id="a" accept="video/mp4">

    <div class="count-display" id="count">0</div>
    <div id="status">Ready to Render</div>

    <button id="go">GENERATE TIKTOK EDIT</button>
    <a id="dl" style="display:none; margin-top:25px; color:#00ffcc; text-decoration:none; font-weight:bold;" href="#">⬇️ DOWNLOAD MP4 ⬇️</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let stayAwakeLock = null;

    async function enableWakeLock() {
        if ('wakeLock' in navigator) {
            try { stayAwakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
        }
    }

    ffmpeg.setLogger(({ message }) => {
        const frameMatch = message.match(/frame=\s*(\d+)/);
        if (frameMatch) document.getElementById('count').innerText = frameMatch[1];
    });

    document.getElementById('go').onclick = async () => {
        const vF = document.getElementById('v').files[0];
        const aF = document.getElementById('a').files[0];
        if(!vF || !aF) return alert("Select your files!");

        await enableWakeLock();
        const btn = document.getElementById('go');
        btn.disabled = true;

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        document.getElementById('status').innerText = "Uploading to Memory...";
        ffmpeg.FS('writeFile', 'v.mp4', await fetchFile(vF));
        ffmpeg.FS('writeFile', 'a.mp4', await fetchFile(aF));

        document.getElementById('status').innerText = "Processing FX (Stay on Page)...";

        /** * FX BREAKDOWN:
         * eq=saturation=1.6 (High vibrance)
         * colorlevels (Deep blacks)
         * zoompan=s=hd720 (Shake simulation)
         * blend (Overlay flicker effect every 0.5s)
         */
        const fx = "[0:v]scale=-1:1080,crop=608:1080,eq=saturation=1.6:contrast=1.3,unsharp=5:5:1.0,zoompan=z='min(zoom+0.001,1.1)':d=1:x='iw/2-(iw/zoom/2)+rand(-5,5)':y='ih/2-(ih/zoom/2)+rand(-5,5)'[v]";

        try {
            await ffmpeg.run(
                '-ss', '00:01:20', '-t', '12',
                '-i', 'vid.mp4', '-i', 'aud.mp4',
                '-filter_complex', fx,
                '-map', '[v]', '-map', '1:a',
                '-c:v', 'libx264', '-preset', 'ultrafast', 'tiktok.mp4'
            );

            const data = ffmpeg.FS('readFile', 'tiktok.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            const dl = document.getElementById('dl');
            dl.href = url; dl.download = "TikTok_Style_Edit.mp4";
            dl.style.display = "block";
            
            document.getElementById('status').innerText = "DONE!";
            if(stayAwakeLock) stayAwakeLock.release();
            btn.disabled = false;
        } catch (e) {
            document.getElementById('status').innerText = "Memory Error. Try shorter video.";
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
